# 2-5 ビルド/配布

Reladen は monorepo 構成であり、Web(PWA) と デスクトップ(Tauri) で  
それぞれ別ディレクトリからビルド・実行を行う。

- Web / PWA: `apps/web`
- デスクトップ(Tauri): `apps/desktop`
- DB スキーマ / シード: リポジトリルート（`pnpm db:push` / `pnpm seed`）

本節では、開発時・本番向けビルド・配布の概要を示す。

## 2-5-1 Web / PWA のビルド

### 開発用サーバー起動

- 作業ディレクトリ: `apps/web`
- コマンド例:

  ```bash
  cd apps/web
  pnpm dev
  ````

* Next.js(App Router) の開発サーバーを起動し、ブラウザからアクセスして動作確認を行う。
* この段階では Service Worker / PWA の挙動は本番と異なる場合があるため、
  PWA の挙動検証は本番ビルド後に行う。

### 本番ビルド

* 作業ディレクトリ: `apps/web`

* コマンド例:

  ```bash
  cd apps/web
  pnpm build
  ```

* Next.js の本番ビルドを実行し、以下を生成する。

  * サーバー／クライアントバンドル
  * PWA 用の Web App Manifest
  * Service Worker（`next-pwa` による生成物を含む）

* ローカルでの本番挙動確認が必要な場合は、
  `pnpm start`（またはプロジェクトで定義している本番起動コマンド）を用いて確認する。

## 2-5-2 デスクトップ(Tauri) アプリのビルド

### ビルド前提

* Tauri のビルドには Rust toolchain が必要となる。

  * Rust のインストール方法やバージョン要件は、開発者向けドキュメント（README 等）で別途定義する。
* デスクトップ版は `apps/desktop` ディレクトリ内に配置された Tauri プロジェクトを基点としてビルドする。

### ビルド手順（概要）

* 作業ディレクトリ: `apps/desktop`

* コマンド例:

  ```bash
  cd apps/desktop
  pnpm tauri:build
  ```

* 上記コマンドにより、ターゲット OS 向けの以下の成果物が生成される。

  * 実行可能バイナリ（例: `.exe`, `.app` 等）
  * 必要に応じてインストーラ形式のパッケージ（`.msi`, `.dmg`, `.AppImage` 等）

### データ保存先

* デスクトップ版は、各 OS が提供するアプリケーションデータ用ディレクトリ（いわゆる *appData* 相当）の配下に
  ローカル DB ファイル `app.db` 等を保存する。
* 具体的なパス例（`%APPDATA%` や `~/Library/Application Support` 等）は OS ごとに異なるため、
  本仕様では「各 OS のアプリケーションデータディレクトリ配下」として抽象的に定義する。
* 実際のパスや移行ポリシーが必要になった場合は、Tauri 設定および別ドキュメントで詳細を管理する。

## 2-5-3 DB スキーマ更新 / シード

Reladen では、Supabase(Postgres) のスキーマ管理に Drizzle ORM を利用する。

### スキーマ更新（マイグレーション）

* 作業ディレクトリ: リポジトリルート

* コマンド例:

  ```bash
  pnpm db:push
  ```

* Drizzle のマイグレーション機能（`drizzle-kit`）を用いて、
  `DATABASE_URL` で指定された Supabase Postgres のスキーマを更新する。

* 主な利用シーン:

  * ローカル開発環境でのスキーマ更新
  * ステージング環境のスキーマ反映

* 本番環境への適用手順や承認フローが必要な場合は、
  別途運用ドキュメントで定義する。

### 初期データ投入（シード）

* 作業ディレクトリ: リポジトリルート

* コマンド例:

  ```bash
  pnpm seed
  ```

* 開発・検証環境向けの初期データを Supabase に投入する。

  * 例：サンプル住人・テスト用 WorldFacts 等

* 原則として本番環境では利用せず、**ローカル開発やステージング環境での利用を想定**する。

## 2-5-4 配布ポリシー（概要）

### Web / PWA の配信

* Web / PWA 版 Reladen は **Vercel** にデプロイすることを前提とする。

  * `apps/web` をデプロイ対象プロジェクトとして設定し、Git リポジトリへの push をトリガにビルド・デプロイが行われる。
  * ビルド時に生成された manifest / Service Worker を含めて、PWA として配信される。
* 対応ブラウザ（例: Chrome, Edge 等）からは、
  ブラウザの「ホーム画面に追加」「アプリとしてインストール」等の機能を通じて
  Reladen を PWA としてインストール可能となる。
* PWA インストール導線や UI 上の案内方法については、UX/画面設計の章で別途定義する。

### デスクトップ(Tauri) 版の配信

* Tauri ビルドによって生成されたインストーラ / バイナリは、
  将来的にダウンロードページ等を通じて配信することを想定する。
* 配信チャネル（例: GitHub Releases、公式サイトからのダウンロード等）や
  自動アップデートの有無については、本仕様時点では確定しない。
* 本章では、

  * 「`apps/desktop` で `pnpm tauri:build` を実行すると、配布可能な成果物が生成される」
  * 「生成物は今後、適切なチャネルでユーザーに提供する」
    というレベルまでを定義範囲とする。
