# 2-4 環境変数

Reladen では、Supabase / GPT-API / 監視サービス / ビルドツールなどの設定値を  
環境変数で管理する。ここでは、主に Web アプリ（Next.js）に関係する環境変数を定義する。

本番環境では、これらの値は **Vercel の環境変数設定**として登録し、  
`.env` ファイルはデプロイ物に含めない前提とする。

## 2-4-1 Supabase 関連

Supabase 接続には、以下の環境変数を使用する。

- `NEXT_PUBLIC_SUPABASE_URL`
  - Supabase プロジェクトの URL。
  - クライアント（ブラウザ）から直接 Supabase に接続するために利用する。
  - `NEXT_PUBLIC_` が付いており、ビルド時にクライアントバンドルへ埋め込まれる。

- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - Supabase の anon 公開キー。
  - クライアントからの認証付きアクセスに使用する。
  - `NEXT_PUBLIC_` が付いているため、**サービスロールキーなどのシークレットは絶対に混在させない**。

- `SUPABASE_SERVICE_ROLE_KEY`
  - Supabase の service role キー。
  - **サーバー側のみ**（Next.js API Route や CLI スクリプト等）で利用する。
  - 高権限キーであり、クライアントバンドルには一切埋め込まない。
  - 用途の例：
    - アカウント削除・データ一括削除
    - メンテナンス用のバックグラウンド処理

- `DATABASE_URL`
  - Supabase Postgres への接続文字列。
  - **Drizzle ORM のマイグレーション（`pnpm db:push` 等）で利用する。**
  - 本番・ステージング・ローカルでそれぞれ異なる値を持ちうる。

## 2-4-2 GPT/LLM（OpenAI）関連

Reladen では、現時点で LLM プロバイダとして **OpenAI** を前提とする。

- `OPENAI_API_KEY`
  - OpenAI API へのアクセスキー。
  - **サーバー側（Next.js API Route 等）からのみ利用し、クライアントには公開しない。**
  - 会話生成・相談生成・WorldFacts 生成・天気コメント生成などの API Route 内で参照される。

将来的に他プロバイダを利用する場合は、  
別途 `XXX_API_KEY` 等の環境変数を追加し、API Route 内で切り替えを行う。

## 2-4-3 監視・ログ関連（Sentry 等）

エラートラッキングやパフォーマンス監視には Sentry を利用することを想定する。

- `NEXT_PUBLIC_SENTRY_DSN`
  - ブラウザ側 Sentry SDK の DSN。
  - クライアントバンドルに埋め込まれることを前提とした公開用 DSN。
  - Web クライアントのエラー・パフォーマンス情報を送信するために使用する。

- `SENTRY_AUTH_TOKEN`
  - Sentry CLI 用の認証トークン。
  - sourcemap のアップロード等、ビルド・デプロイパイプラインで利用する。
  - 高権限トークンであり、クライアントバンドルには一切埋め込まない。

- `SENTRY_DSN` / `SENTRY_ENVIRONMENT`
  - 必要に応じてサーバー側 Sentry SDK 等で利用することを想定した変数。
  - 現時点では具体的な運用は未確定のため、  
    利用する場合は README もしくは別ドキュメントで詳細を定義する。

## 2-4-4 その他の公開環境変数

アプリの動作に必要だが、シークレットではない値は `NEXT_PUBLIC_` プレフィックス付きで管理する。

- `NEXT_PUBLIC_CONTACT_URL`
  - アプリ内から参照する「問い合わせフォーム」「連絡先ページ」等の URL。
  - クライアント側で直接参照されるため、`NEXT_PUBLIC_` を付与した公開用変数として扱う。

- （将来導入する場合）`NEXT_PUBLIC_APP_ENV` など
  - 動作モード（例：`local` / `staging` / `production` 等）を表現するための環境変数。
  - 現時点では未導入であり、本仕様では**必須ではない**。
  - 導入する場合は、ログレベルや実験的機能の ON/OFF などの分岐に使用することを想定する。

## 2-4-5 .env ファイルと本番運用ルール

### ローカル開発時のファイル配置

- プロジェクトルートの `.env`
  - 共通の開発用値を定義する。
  - 例：
    - `NEXT_PUBLIC_SUPABASE_URL`
    - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
    - `SUPABASE_SERVICE_ROLE_KEY`
    - `DATABASE_URL`
    - `SENTRY_AUTH_TOKEN`
    - `NEXT_PUBLIC_CONTACT_URL`

- `apps/web/.env.local`
  - Web アプリ固有のローカル開発用値を追加定義する。
  - 例：
    - 上記に加えて `NEXT_PUBLIC_SENTRY_DSN`
    - `OPENAI_API_KEY`
  - `*.local` 系ファイルは git 管理外とし、開発者ごとにローカルで設定する。

### 本番・ステージング環境

- 本番およびステージング環境では、**すべて Vercel 上の環境変数として管理する。**
  - `.env` / `.env.local` ファイルをサーバーへ配布しない。
  - Supabase / OpenAI / Sentry / DATABASE_URL 等、すべて Vercel のダッシュボードから設定する。
- `NEXT_PUBLIC_` が付く環境変数はクライアントバンドルへ埋め込まれるため、  
  シークレット（サービスロールキー、OpenAI キー、Sentry 認証トークン等）は **必ず非公開プレフィックスの変数**で管理する。

### Tauri との関係

- 現時点では、Tauri 専用の追加環境変数や独自の運用ルールは定めない。
- 必要に応じて、Web アプリと同様に `.env` / Vercel 環境変数から値を受け取り、  
  Tauri 側に渡す形で運用する。
