# 2-1 全体構成

Reladen は、以下の 3 層構成を基本とする。

- クライアント層  
  - Web クライアント（PWA, Next.js App Router）
  - デスクトップクライアント（Tauri + WebView）

- アプリケーションサーバ層  
  - Next.js App Router のサーバー機能（API Route 等）

- バックエンド／データストア層  
  - Supabase（Postgres, Auth, Realtime 等）
  - GPT-API（会話・相談・WorldFacts・天気コメント生成）

## 2-1-1 クライアント構成

### Web クライアント（PWA）

- Next.js App Router を用いた Web アプリケーション。
- Service Worker と各種キャッシュ機構により、**PWA としてインストール可能**な形で提供する。
- ブラウザ内での利用を前提とし、以下を担う。
  - 住人一覧・関係・印象・会話ログ等の UI 表示・編集
  - IndexedDB を用いたローカルキャッシュ（短期オフライン編集含む）
  - アプリ内通知（トースト等）の表示  
    - OS レベルのプッシュ通知（Web Push）については、将来的な検討対象とし、本仕様では必須要件としない。

### デスクトップクライアント（Tauri）

- Tauri により、デスクトップ向けネイティブアプリとして提供する。
- UI には **Web クライアントと同一の Next.js アプリ**を WebView として利用し、  
  画面構成および UX は原則として両クライアントで共通とする。
- 以下の役割を持つ。
  - ネイティブインストーラ／実行ファイルとしての配布
  - Tauri 側で提供されるローカル保存領域（`app.db`）へのアクセス
    - ローカル DB は SQLite（`app.db`）を用いる想定とする。
    - 現時点では暗号化は行わず、**将来的に SQLCipher 等による暗号化導入を検討する項目**とする。
  - オフライン時の閲覧・短期編集の継続
  - （将来検討）OS の通知センター等を利用したシステム通知

### クライアント間の位置づけ

- Web（PWA）・デスクトップ（Tauri）**いずれも正式なターゲットクライアント**とし、機能面では可能な限り同等とする。
- UI ロジックは Next.js アプリとして共通化し、Tauri はこれをラップする構成とする。
- 両者とも、後述の Supabase およびローカル DB と同期しながら動作する。

## 2-1-2 データストアと同期の前提

### Supabase（正本データ）

- Supabase（Postgres）は、Reladen における**世界の正本データ**を保持する。
  - 例：住人情報・関係・印象・会話メタデータ・WorldFacts 等
- クライアントからは、**主に Supabase JS SDK による直接アクセス**（PostgREST 経由）を行う。
  - 単純な CRUD やリアルタイム購読（Realtime）は SDK による直接利用を前提とする。
- Row Level Security（RLS）や `owner_id` によるアクセス制御の詳細は、セキュリティ章で別途定義する。

### ローカル DB（IndexedDB / `app.db`）

- 各クライアントは、以下のローカル DB を用いて **キャッシュおよび短期オフライン編集**を行う。
  - Web クライアント: IndexedDB
  - デスクトップクライアント: SQLite（`app.db`）
- ローカル DB に保持するデータは、原則として Supabase 上の主要テーブルのミラー／部分ミラーとする。
  - 一部、クライアント設定やローカル専用メタ情報を持つ場合があるが、  
    その扱いは該当章で明示する。
- **オンライン前提・オフライン補助**の思想に基づき、以下を前提とする。
  - Supabase 上のレコードが常に正本である。
  - ローカル DB は、オンライン復帰時に Supabase と同期されるキャッシュ＋短期オフライン編集領域として扱う。
  - 同期アルゴリズムおよび競合解決（最終更新勝ち等）の詳細は、同期節で定義する。

### 同期 API（`/app/api/sync/{table}`）

- ローカル DB と Supabase 間の差分同期・tombstone の処理など、**複雑な同期ロジック**は Next.js の API Route で行う。
  - 代表例として `/app/api/sync/{table}` を用意し、  
    クライアントからローカルの差分情報を送信 → サーバー側でマージ → Supabase 更新 → 差分返却、という流れを担う。
- 通常の単純な取得・更新は Supabase SDK から直接行い、  
  **同期や一括マージが必要なケースのみ API Route を利用**する。

## 2-1-3 GPT-API 利用構成

### アクセス経路

- GPT-API へのアクセスは、**必ず Next.js の API Route 経由で行う。**
  - 例：
    - 会話開始: `POST /app/api/conversations/start`
    - 相談生成: `POST /app/api/consultations/start`
    - WorldFacts 生成: `POST /app/api/world-facts/generate`
    - 天気コメント生成: `POST /app/api/weather/comment`
- クライアントは GPT ベンダー（OpenAI 等）を直接呼び出さず、  
  API Route を通して間接的に利用する。
- API キーはサーバー側環境変数として管理し、クライアントには開示しない。

### GPT-API の主な用途

- 会話生成
  - 住人ペアの会話テキスト生成、および会話ログへの保存。
- 相談生成
  - 住人からプレイヤーへの相談テキスト（相談内容）の生成。
- WorldFacts 生成
  - 世界内での出来事（WorldFacts）の生成、およびそれに基づくトピック候補の作成。
- 天気コメント生成
  - 外部の天気情報や内部状態を踏まえた、住人の自然な天気コメントの生成。

## 2-1-4 オンライン前提とオフライン補助

- Reladen は **オンライン動作を前提とした設計**とし、Supabase および GPT-API への接続が可能な状態を基本とする。
- 一方で、短時間のオフラインや一時的なネットワーク不安定状態に対しては、以下の範囲で補助的な動作を保証する。
  - ローカル DB（IndexedDB / `app.db`）にキャッシュされたデータの閲覧
  - 一部の更新操作（後で同期される前提の編集）の実行
- オフライン時に行われた変更は、オンライン復帰後に同期 API を通じて Supabase と整合される。
- GPT-API を必要とする処理（新規会話生成・新規相談生成等）は、オンラインでのみ実行される前提とする。
