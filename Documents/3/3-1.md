# 3-1 共通項目

本システムのアプリケーション機能に紐づくテーブル（住人、関係、印象、会話、WorldFacts、Topic、天気、イベント、実績、その他付随テーブル）は、共通して次のカラムを持つ。

- `id`: `uuid`  
  各行を一意に識別する ID。クライアント側・サーバ側を問わず、この値を主キーとして扱う。

- `updated_at`: `timestamptz`  
  行の「最終更新時刻」。ローカル DB（IndexedDB）とクラウド DB（Supabase/PostgreSQL）の同期において、**競合解消の基準**として利用する。

- `deleted`: `boolean`（デフォルト `false`）  
  論理削除フラグ。tombstone 運用のために用いられる。

- `owner_id`: `uuid`  
  行の所有者（アカウント）を示す ID。RLS（Row Level Security）によるアクセス制御のキーとなる。

なお、本仕様における「全テーブル」とは、上記のような **アプリ機能に直接関わるドメインデータのテーブルおよびその中間テーブル** を指し、マイグレーション履歴などのシステム内部テーブルは含まない。

---

## tombstone（論理削除）の意味と状態遷移

### 1. `deleted` の意味

- `deleted = false`  
  - 通常のアクティブな行として扱う。
  - アプリケーションの通常画面・API から参照される前提。

- `deleted = true`  
  - 「tombstone（論理削除済み）」として扱う。
  - 通常の一覧・取得処理では **基本的にクエリ対象から除外** する。
  - 履歴やデバッグ目的で参照する特殊なクエリを除き、ユーザー向け UI からは見えない。

### 2. 状態遷移

- 状態遷移は次の一方向のみをサポートする：

  - `deleted: false  →  true`

- 一度 `deleted = true` になった行は、**アプリケーション仕様上は復元しない** 前提とする。  
  - ユーザー向け UI として「復元」機能は提供しない。  
  - 必要な復旧が発生した場合は、DB のバックアップや運用レベルでの対応とし、本仕様の対象外とする。

---

## `updated_at` の扱いと同期ポリシー

### 1. 更新主体

- `updated_at` は、**アプリケーション層（クライアント / サーバーアクションを含む）が更新を行うたびに明示的に書き換える**。
  - 例：更新処理の直前または直後に、アプリ側で現在時刻をセットして保存する。
- DB 側のトリガーに依存せず、**アプリケーションコードが責任を持って「最終更新時刻」を管理する** 方針とする。

（実装上、サーバー時刻・ローカル時刻の扱いなど細部はアプリケーション実装の責務とし、本章では詳細には踏み込まない。）

### 2. 競合解消（最終更新勝ち）

ローカル DB（IndexedDB）と Supabase/PostgreSQL 間で同期を行う際、同一 `id` の行に差分が存在する場合は、以下のルールで解決する。

- **最終更新勝ち（Last-Write-Wins）モデル** を採用する。
  - 比較対象：ローカル側の `updated_at` とクラウド側の `updated_at`
  - `updated_at` が新しい方を「最新の真実」とみなし、もう片方を上書きする。

このポリシーにより、同一レコードに対する複数端末・複数コンテキストからの編集競合は、単純な時間ベースで解決される。

---

## `owner_id` と RLS の前提

### 1. `owner_id` の意味

- `owner_id` は、その行の論理的な所有者となるユーザー（アカウント）の ID を指す。
- Reladen は現時点で「全ユーザー共通のグローバルデータ」を想定せず、**各ユーザーごとに独立した世界を持つ設計**であるため、住人や会話などの行はすべて、いずれかの `owner_id` に属する。

### 2. Preset データとの関係

- 住人プリセット・性格プリセット等の **Preset 系データは、共通テーブルとして共有するのではなく、初期設定時に各ユーザーごとに同一のデフォルトデータを配布する** 方針とする。
  - つまり、Preset の内容自体は共通だが、**各ユーザーごとに `owner_id` が割り振られた行として独立して存在する**。
  - これにより、Preset 由来の住人等も、ユーザー独自の編集・削除が可能となる。

### 3. RLS の基本ポリシー

- Supabase 上では、**`owner_id` を用いた Row Level Security（RLS）** によって、行レベルでアクセス範囲を制限する。
- 原則として、**ユーザー文脈でのすべての DB アクセスは、`owner_id = 現在のユーザー ID` を満たす行のみを読み書きできる**ようにルールを定義する。
- アプリケーションコード（クライアント / サーバーアクション）は、この前提を崩さないよう実装する。

（サービスロールを用いる管理操作などの詳細は、アーキテクチャ・セキュリティ関連の章で扱う。）
