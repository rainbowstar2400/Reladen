# 1-6 前提・制約

本仕様書に記述する各機能は、以下の技術的・環境的前提および制約条件に基づいて動作する。

---

## ■ 技術基盤の前提

- 本アプリは **オンライン動作を基本前提** とし、
GPT-API および Supabase（Postgres）への接続が確立している状態を標準動作とする。

- 会話生成・関係変化の一部処理・新聞生成など、
GPT-API を利用する機能は **オンライン依存** とする。

- データストアとして Supabase（Postgres）を使用し、
`RLS（Row Level Security）` によってユーザーデータは `owner_id` で隔離する。

---

## ■ データ保持・同期モデルの前提

- Web（PWA）では **IndexedDB**、デスクトップ（Tauri）では **ローカル DB（app.db）** を
ローカル保持領域として利用する。

- ローカル DB は **補助的な一時保持領域** とし、
正本データ（canonical state）は **Supabase を基準** とする。

- オフライン時は、住人情報や一部状態の更新を許可するが、
**会話生成などオンライン依存機能は実行されない。**

- オフライン動作は短期的な利用を想定し、
**長期間の完全オフライン環境での継続動作は保証しない。**

- オンライン復帰時には Supabase とローカル DB を同期し、
原則として **Supabase 側の最終更新を優先（Last-write-wins）** とする。

---

## ■ 実行モデル（世界の進行）に関する前提

- 世界の進行（会話発火・就寝判定・状態更新など）は **端末の現在時刻に依存し、現実時間と同期** して動作する。

- 端末時刻を大幅に変更した場合の挙動は保証しない。

- **自動会話スケジューラは常に 1 インスタンスのみ動作する** ことを前提とする。
Web 版ではロック（例：localStorage Lock）によってマルチタブ衝突を回避する。

---

## ■ 通信・セキュリティの前提

- 通信は常に **HTTPS** を必須とする。

- Supabase の公開鍵（anon key）のみクライアントへ配置し、
**Service Role Key はクライアントに含めない。**

- GPT API キーはブラウザ環境に埋め込まず、
**Tauri では OS 側の安全領域（環境変数等）を利用して保持する。**

- 秘匿情報は Service Worker やブラウザキャッシュに保存しない。

---

## ■ プライバシー・データ扱い上の前提

- GPT API に送信される内容はユーザー生成コンテンツ（住人設定・会話ログ）であり、
個人情報を含まない前提で設計する。

- `tombstone`（論理削除）運用により、削除済みデータは
**復元不可の扱い** とし、開発者が任意に参照しない。

---

## ■ 動作保証外となるケース

- 端末時刻・タイムゾーンを短期間で大きく変更した場合
- 複数タブでスケジューラを強制的に同時稼働させた場合
- IndexedDB がブラウザ制限等により正常に動作しない環境
- 長期間オフラインが継続し、同期不能となった場合
